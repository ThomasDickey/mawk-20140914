# $MawkId: Makefile.in,v 1.16 2009/09/18 00:16:32 tom Exp $
# Makefile-template for MAWK

SHELL=/bin/sh

####################################

x               = @EXEEXT@
o               = .@OBJEXT@

prefix          = @prefix@
exec_prefix     = @exec_prefix@

srcdir		= @srcdir@

manext		= 1
bindir		= @bindir@
mandir		= @mandir@/man$(manext)

CC              = @CC@

CPPFLAGS	= @CPPFLAGS@
EXTRA_CFLAGS	= @EXTRA_CFLAGS@
CFLAGS          = @CFLAGS@ $(EXTRA_CFLAGS)
LDFLAGS         = @LDFLAGS@
MATHLIB         = @MATHLIB@

YACC            = @YACC@

INSTALL         = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA    = @INSTALL_DATA@

# where to put mawk
BINDIR          = $(DESTDIR)$(bindir)

# where to put the man pages
MANDIR          = $(DESTDIR)$(mandir)

#######################################

PROG  = mawk$x

OBJS = parse$o scan$o memory$o main$o hash$o execute$o code$o \
  da$o error$o init$o bi_vars$o cast$o print$o bi_funct$o \
  kw$o jmp$o array$o field$o split$o re_cmpl$o regexp$o zmalloc$o \
  fin$o files$o scancode$o matherr$o fcall$o version$o \
  missing$o

.SUFFIXES: .c .i $o

.c.i :
@RULE_CC@
	@ECHO_CC@$(CPP) -C $(CPPFLAGS) $< >$@
.c$o :
@RULE_CC@
	@ECHO_CC@$(CC) -c $(CPPFLAGS) $(CFLAGS) $<

all :	$(PROG)

check :  mawk_test fpe_test

$(PROG) : $(OBJS)
	@ECHO_LD@$(CC) $(LDFLAGS) -o $@ $(OBJS) $(MATHLIB)

TESTPATH= PATH=`pwd`:`cd $(srcdir);pwd`/test:/bin:/usr/bin; export PATH

mawk_test :  $(PROG)  # test that we have a sane mawk
	sh -c '$(TESTPATH); cd $(srcdir)/test ; mawktest $(srcdir)'

fpe_test :  $(PROG) # test FPEs are handled OK
	sh -c '$(TESTPATH); cd $(srcdir)/test ; fpe_test $(srcdir)'

parse.c  : parse.y
	@echo  expect 4 shift/reduce conflicts
	$(YACC) -d parse.y
	mv y.tab.c parse.c
	-if cmp -s y.tab.h parse.h ;\
	   then rm y.tab.h ;\
	   else mv y.tab.h parse.h ; fi

array.c : array.w
	-@rm -f $@
	notangle -R'"array.c"' array.w | cpif array.c

array.h : array.w
	-@rm -f $@
	notangle -R'"array.h"' array.w | cpif array.h

scancode.c :  makescan.c  scan.h
	@ECHO_LD@$(CC) -o makescan.exe  makescan.c
	rm -f scancode.c
	./makescan.exe > scancode.c
	rm makescan.exe

MAWKMAN = $(MANDIR)/mawk.$(manext)
install :  $(BINDIR) $(MANDIR) $(PROG)
	$(INSTALL_PROGRAM) $(PROG) $(BINDIR)/$(PROG)
	$(INSTALL_DATA)  man/mawk.1  $(MAWKMAN)

uninstall :
	rm -f $(BINDIR)/$(PROG)
	rm -f $(MAWKMAN)

clean :
	rm -f *$o test/$(PROG) *core* test/*core* $(PROG)

distclean :  clean
	rm -f config.h Makefile \
	    config.status config.log config.cache
	rm -f defines.out maxint.out fpe_check tags 

tags :
	ctags *.[ch] */*.[ch]

TAGS :
	etags *.[ch] */*.[ch]

$(BINDIR) \
$(MANDIR) :
	sh -c "mkdirs.sh $@"

# output from  mawk -f deps.awk *.c
array.o : config.h field.h bi_vars.h mawk.h symtype.h nstd.h memory.h array.h zmalloc.h types.h sizes.h
bi_funct.o : config.h field.h bi_vars.h mawk.h init.h regexp.h symtype.h nstd.h repl.h memory.h bi_funct.h array.h files.h zmalloc.h fin.h types.h sizes.h
bi_vars.o : config.h field.h bi_vars.h mawk.h init.h symtype.h nstd.h memory.h array.h zmalloc.h types.h sizes.h
cast.o : config.h field.h mawk.h parse.h symtype.h nstd.h memory.h repl.h scan.h array.h zmalloc.h types.h sizes.h
code.o : config.h field.h code.h mawk.h init.h symtype.h nstd.h memory.h array.h jmp.h zmalloc.h types.h sizes.h
da.o : config.h field.h code.h mawk.h symtype.h nstd.h memory.h repl.h bi_funct.h array.h zmalloc.h types.h sizes.h
error.o : config.h bi_vars.h mawk.h parse.h symtype.h nstd.h scan.h array.h types.h sizes.h
execute.o : config.h field.h bi_vars.h code.h mawk.h regexp.h symtype.h nstd.h memory.h repl.h bi_funct.h array.h zmalloc.h types.h fin.h sizes.h
fcall.o : config.h code.h mawk.h symtype.h nstd.h memory.h array.h zmalloc.h types.h sizes.h
field.o : config.h field.h bi_vars.h mawk.h init.h parse.h regexp.h symtype.h nstd.h memory.h repl.h scan.h array.h zmalloc.h types.h sizes.h
files.o : config.h mawk.h nstd.h memory.h files.h zmalloc.h types.h fin.h sizes.h
fin.o : config.h field.h bi_vars.h mawk.h parse.h symtype.h nstd.h memory.h scan.h array.h zmalloc.h types.h fin.h sizes.h
hash.o : config.h mawk.h symtype.h nstd.h memory.h array.h zmalloc.h types.h sizes.h
init.o : config.h field.h bi_vars.h code.h mawk.h init.h symtype.h nstd.h memory.h array.h zmalloc.h types.h sizes.h
jmp.o : config.h code.h mawk.h init.h symtype.h nstd.h memory.h array.h jmp.h zmalloc.h types.h sizes.h
kw.o : config.h mawk.h init.h parse.h symtype.h nstd.h array.h types.h sizes.h
main.o : config.h code.h mawk.h init.h symtype.h nstd.h memory.h array.h files.h zmalloc.h types.h sizes.h
makescan.o : parse.h symtype.h scan.h array.h
matherr.o : config.h mawk.h nstd.h types.h sizes.h
memory.o : config.h mawk.h nstd.h memory.h zmalloc.h types.h sizes.h
missing.o : config.h nstd.h
parse.o : config.h field.h bi_vars.h code.h mawk.h symtype.h nstd.h memory.h bi_funct.h array.h files.h zmalloc.h jmp.h types.h sizes.h
print.o : config.h field.h bi_vars.h mawk.h parse.h symtype.h nstd.h memory.h scan.h bi_funct.h array.h files.h zmalloc.h types.h sizes.h
re_cmpl.o : config.h mawk.h parse.h regexp.h symtype.h nstd.h memory.h repl.h scan.h array.h zmalloc.h types.h sizes.h
scan.o : config.h field.h code.h mawk.h init.h parse.h symtype.h nstd.h memory.h repl.h scan.h array.h files.h zmalloc.h types.h fin.h sizes.h
split.o : config.h field.h bi_vars.h mawk.h parse.h regexp.h symtype.h nstd.h memory.h scan.h bi_funct.h array.h zmalloc.h types.h sizes.h
version.o : config.h mawk.h patchlev.h nstd.h types.h sizes.h
zmalloc.o : config.h mawk.h nstd.h zmalloc.h types.h sizes.h
regexp.o : regexp.c regexp_system.c rexp0.c rexp1.c rexp2.c rexp3.c rexp4.c rexp.c rexpdb.c rexp.h
